<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MCP Layer Mode Test - River Raid</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #1a1a2e; 
      color: #eee; 
      padding: 20px;
      min-height: 100vh;
    }
    h1 { color: #00d4ff; margin-bottom: 20px; }
    .container { max-width: 1200px; margin: 0 auto; }
    .controls { 
      display: flex; 
      gap: 10px; 
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    button { 
      padding: 12px 24px; 
      font-size: 14px; 
      cursor: pointer;
      background: #16213e;
      color: #fff;
      border: 2px solid #00d4ff;
      border-radius: 8px;
      transition: all 0.3s;
    }
    button:hover { 
      background: #00d4ff; 
      color: #1a1a2e;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    button.sim-btn {
      background: #2d5016;
      border-color: #00ff00;
    }
    button.sim-btn:hover {
      background: #00ff00;
    }
    .game-container {
      position: relative;
      width: 100%;
      height: 650px;
      border: 3px solid #00d4ff;
      border-radius: 12px;
      overflow: hidden;
      background: #000;
    }
    .game-container iframe {
      width: 100%;
      height: 100%;
      border: none;
    }
    .log-container {
      margin-top: 20px;
      background: #16213e;
      border-radius: 12px;
      padding: 15px;
      max-height: 400px;
      overflow-y: auto;
    }
    .log-container h3 {
      color: #00d4ff;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .log-entry {
      font-family: 'Monaco', 'Consolas', monospace;
      font-size: 12px;
      padding: 8px;
      margin: 4px 0;
      border-radius: 4px;
      word-break: break-all;
    }
    .log-entry.sent { background: #1e3a5f; border-left: 3px solid #00d4ff; }
    .log-entry.received { background: #2d1f3d; border-left: 3px solid #ff00ff; }
    .log-entry .time { color: #888; margin-right: 10px; }
    .log-entry .type { font-weight: bold; }
    .status-bar {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
      padding: 15px;
      background: #16213e;
      border-radius: 8px;
    }
    .status-item {
      display: flex;
      flex-direction: column;
    }
    .status-item label { color: #888; font-size: 12px; }
    .status-item value { color: #00d4ff; font-size: 18px; font-weight: bold; }
    .clear-btn {
      background: transparent;
      border: 1px solid #666;
      padding: 4px 12px;
      font-size: 12px;
    }
    .test-result {
      padding: 15px;
      margin-top: 10px;
      border-radius: 8px;
      font-weight: bold;
    }
    .test-result.pass { background: #1a4d1a; border: 2px solid #00ff00; }
    .test-result.fail { background: #4d1a1a; border: 2px solid #ff0000; }
    .test-result.pending { background: #4d4d1a; border: 2px solid #ffff00; }
    .result-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 11px;
    }
    .result-table th, .result-table td {
      padding: 8px;
      text-align: left;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .result-table th {
      background: rgba(0,212,255,0.1);
      color: #00d4ff;
    }
    .result-table tr:hover {
      background: rgba(255,255,255,0.05);
    }
    .pass-cell { color: #00ff00; }
    .fail-cell { color: #ff0000; }
  </style>
</head>
<body>
  <div class="container">
    <h1>MCP Layer Mode Test - River Raid</h1>
    
    <div class="status-bar">
      <div class="status-item">
        <label>Durum</label>
        <value id="status">Bekliyor</value>
      </div>
      <div class="status-item">
        <label>Skor</label>
        <value id="score">0</value>
      </div>
      <div class="status-item">
        <label>Can</label>
        <value id="lives">3</value>
      </div>
      <div class="status-item">
        <label>Alƒ±nan Mesaj</label>
        <value id="msgCount">0</value>
      </div>
    </div>

    <div class="controls">
      <button onclick="openGame()">Oyunu A√ß</button>
      <button onclick="sendInit()" id="initBtn" disabled>Init G√∂nder</button>
      <button onclick="sendControl('play')" id="playBtn" disabled>Play</button>
      <button onclick="sendControl('pause')" id="pauseBtn" disabled>Pause</button>
      <button onclick="sendControl('resume')" id="resumeBtn" disabled>Resume</button>
      <button onclick="sendControl('restart')" id="restartBtn" disabled>Restart</button>
      <button onclick="closeGame()">Kapat</button>
      <button class="sim-btn" onclick="runGameSimulation()">üéÆ Oyun Sim√ºlasyonu</button>
    </div>

    <div class="game-container" id="gameContainer">
      <div style="display:flex;align-items:center;justify-content:center;height:100%;color:#666;">
        Oyun y√ºklenmedi. "Oyunu A√ß" butonuna tƒ±klayƒ±n.
      </div>
    </div>

    <div id="testResult"></div>

    <div class="log-container">
      <h3>
        MCP Mesaj Loglarƒ±
        <button class="clear-btn" onclick="clearLogs()">Temizle</button>
      </h3>
      <div id="logs"></div>
    </div>
  </div>

  <script>
    const GAME_URL = window.location.origin;
    let gameFrame = null;
    let msgCount = 0;
    let receivedMessages = [];

    function log(direction, type, data) {
      const logsDiv = document.getElementById('logs');
      const time = new Date().toLocaleTimeString('tr-TR');
      const entry = document.createElement('div');
      entry.className = `log-entry ${direction}`;
      entry.innerHTML = `
        <span class="time">[${time}]</span>
        <span class="type">${direction === 'sent' ? 'üì§' : 'üì©'} ${type}</span>
        <pre style="margin-top:5px;color:#aaa;">${JSON.stringify(data, null, 2)}</pre>
      `;
      logsDiv.insertBefore(entry, logsDiv.firstChild);
    }

    function clearLogs() {
      document.getElementById('logs').innerHTML = '';
      msgCount = 0;
      document.getElementById('msgCount').textContent = '0';
      receivedMessages = [];
    }

    function updateStatus(status) {
      document.getElementById('status').textContent = status;
    }

    function enableControls(enable) {
      ['initBtn', 'playBtn', 'pauseBtn', 'resumeBtn', 'restartBtn'].forEach(id => {
        document.getElementById(id).disabled = !enable;
      });
    }

    window.addEventListener('message', (event) => {
      const data = event.data;
      if (!data || !data.type || !data.type.startsWith('mcp:')) return;

      msgCount++;
      document.getElementById('msgCount').textContent = msgCount;
      receivedMessages.push(data);

      log('received', data.type, data);

      switch(data.type) {
        case 'mcp:ready':
          updateStatus('Hazƒ±r');
          enableControls(true);
          break;
        case 'mcp:progress':
          if (data.data) {
            if (data.data.score !== undefined) {
              document.getElementById('score').textContent = data.data.score;
            }
            if (data.data.lives !== undefined) {
              document.getElementById('lives').textContent = data.data.lives;
            }
            if (data.data.status) {
              updateStatus(data.data.status);
            }
          }
          break;
        case 'mcp:complete':
          updateStatus('Oyun Bitti');
          if (data.data) {
            document.getElementById('score').textContent = data.data.finalScore || data.finalScore || 0;
          }
          break;
        case 'mcp:cancel':
          updateStatus('ƒ∞ptal');
          break;
        case 'mcp:error':
          updateStatus('Hata: ' + (data.error?.message || 'Bilinmiyor'));
          break;
      }
    });

    function openGame() {
      const container = document.getElementById('gameContainer');
      container.innerHTML = '';
      
      gameFrame = document.createElement('iframe');
      gameFrame.src = `${GAME_URL}/?mode=layer&username=TestKullanici&language=tr&theme=dark`;
      container.appendChild(gameFrame);
      
      log('sent', 'iframe opened', { src: gameFrame.src });
      updateStatus('Y√ºkleniyor...');
      clearLogs();
      receivedMessages = [];
      msgCount = 0;
      document.getElementById('msgCount').textContent = '0';
    }

    function sendInit() {
      if (!gameFrame) return;
      
      const initMessage = {
        type: 'mcp:init',
        context: {
          customerId: 'test-customer-123',
          projectId: 'test-project-456',
          userId: 'test-user-789',
          resourceId: 'game-session-' + Date.now(),
          token: 'test-token-abc',
          config: { theme: 'dark' },
          params: { username: 'MCPTestUser' }
        }
      };
      
      gameFrame.contentWindow.postMessage(initMessage, '*');
      log('sent', 'mcp:init', initMessage);
    }

    function sendControl(action) {
      if (!gameFrame) return;
      
      const controlMessage = {
        type: 'mcp:control',
        payload: { action: action }
      };
      
      gameFrame.contentWindow.postMessage(controlMessage, '*');
      log('sent', 'mcp:control', controlMessage);
    }

    function closeGame() {
      if (gameFrame) {
        const closeMessage = { type: 'mcp:close', payload: { reason: 'user_closed' } };
        gameFrame.contentWindow.postMessage(closeMessage, '*');
        log('sent', 'mcp:close', closeMessage);
      }
      
      const container = document.getElementById('gameContainer');
      container.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#666;">Oyun kapatƒ±ldƒ±.</div>';
      gameFrame = null;
      enableControls(false);
      updateStatus('Kapalƒ±');
    }

    async function runGameSimulation() {
      const resultDiv = document.getElementById('testResult');
      resultDiv.innerHTML = '<div class="test-result pending">‚è≥ Sim√ºlasyon ba≈ülatƒ±lƒ±yor...</div>';
      
      clearLogs();
      receivedMessages = [];

      // 1. Oyunu a√ß
      console.log('1. Oyun a√ßƒ±lƒ±yor...');
      openGame();
      updateStatus('Sim√ºlasyon: Oyun a√ßƒ±lƒ±yor');
      
      // mcp:ready bekle
      await new Promise(r => setTimeout(r, 3000));
      
      if (!receivedMessages.find(m => m.type === 'mcp:ready')) {
        resultDiv.innerHTML = '<div class="test-result fail">‚ùå BA≈ûARISIZ: mcp:ready mesajƒ± alƒ±namadƒ±</div>';
        return;
      }
      
      console.log('2. Init g√∂nderiliyor...');
      resultDiv.innerHTML = '<div class="test-result pending">‚è≥ Init g√∂nderiliyor...</div>';
      sendInit();
      await new Promise(r => setTimeout(r, 500));
      
      // Play komutunu g√∂nder
      console.log('3. Oyun ba≈ülatƒ±lƒ±yor...');
      resultDiv.innerHTML = '<div class="test-result pending">‚è≥ Oyun ba≈ülatƒ±lƒ±yor...</div>';
      sendControl('play');
      updateStatus('Sim√ºlasyon: Oyun oynanƒ±yor');
      await new Promise(r => setTimeout(r, 3000));
      
      // Pause
      console.log('4. Oyun duraklatƒ±lƒ±yor...');
      resultDiv.innerHTML = '<div class="test-result pending">‚è≥ Oyun duraklatƒ±lƒ±yor...</div>';
      sendControl('pause');
      updateStatus('Sim√ºlasyon: Oyun duraklatƒ±ldƒ±');
      await new Promise(r => setTimeout(r, 1000));
      
      // Resume
      console.log('5. Oyun devam ettiriliyor...');
      resultDiv.innerHTML = '<div class="test-result pending">‚è≥ Oyun devam ettiriliyor...</div>';
      sendControl('resume');
      updateStatus('Sim√ºlasyon: Oyun oynanƒ±yor');
      await new Promise(r => setTimeout(r, 2000));
      
      // Oyunu kapat - bu mcp:cancel mesajƒ± tetiklemeli
      console.log('6. Oyun kapatƒ±lƒ±yor...');
      resultDiv.innerHTML = '<div class="test-result pending">‚è≥ Oyun kapatƒ±lƒ±yor...</div>';
      closeGame();
      updateStatus('Sim√ºlasyon: Bitti');
      
      await new Promise(r => setTimeout(r, 1000));
      
      // Analiz et
      console.log('Alƒ±nan mesajlar:', receivedMessages);
      
      const readyMsg = receivedMessages.find(m => m.type === 'mcp:ready');
      const progressMsgs = receivedMessages.filter(m => m.type === 'mcp:progress');
      const completeMsg = receivedMessages.find(m => m.type === 'mcp:complete');
      const cancelMsg = receivedMessages.find(m => m.type === 'mcp:cancel');
      
      const tests = [
        {
          name: 'mcp:ready alƒ±ndƒ±',
          pass: !!readyMsg,
          value: readyMsg ? 'Evet' : 'Hayƒ±r'
        },
        {
          name: 'mcp:progress alƒ±ndƒ±',
          pass: progressMsgs.length > 0,
          value: `${progressMsgs.length} adet`
        },
        {
          name: 'mcp:cancel alƒ±ndƒ±',
          pass: !!cancelMsg,
          value: cancelMsg ? 'Evet' : 'Hayƒ±r'
        },
      ];

      if (cancelMsg) {
        tests.push(
          {
            name: 'finalScore var',
            pass: cancelMsg.data?.finalScore !== undefined,
            value: cancelMsg.data?.finalScore ?? 'Yok'
          },
          {
            name: 'highScore var',
            pass: cancelMsg.data?.highScore !== undefined,
            value: cancelMsg.data?.highScore ?? 'Yok'
          },
          {
            name: 'difficulty var',
            pass: cancelMsg.data?.difficulty !== undefined,
            value: (cancelMsg.data?.difficulty ?? 'Yok').toFixed(2)
          },
          {
            name: 'playTime var',
            pass: cancelMsg.data?.playTime !== undefined,
            value: `${cancelMsg.data?.playTime ?? 'Yok'} sn`
          },
          {
            name: 'completed var',
            pass: cancelMsg.data?.completed !== undefined,
            value: cancelMsg.data?.completed ? 'Evet' : 'Hayƒ±r'
          },
          {
            name: 'enemiesDestroyed var',
            pass: cancelMsg.data?.enemiesDestroyed !== undefined,
            value: cancelMsg.data?.enemiesDestroyed ?? 'Yok'
          }
        );
      }
      
      const allPassed = tests.every(t => t.pass);
      const cancelData = cancelMsg?.data || {};
      
      let html = `
        <div class="test-result ${allPassed ? 'pass' : 'fail'}">
          <h3>${allPassed ? '‚úÖ T√úM TESTLER BA≈ûARILI' : '‚ö†Ô∏è BAZI TESTLER BA≈ûARISIZ'}</h3>
          <p>Toplam alƒ±nan mesaj: <strong>${receivedMessages.length}</strong></p>
          <p>mcp:cancel mesajƒ± i√ßeriƒüi:</p>
          <pre style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 4px; margin-top: 10px; font-size: 11px; overflow-x: auto;">
${JSON.stringify(cancelData, null, 2)}
          </pre>
          <table class="result-table">
            <thead>
              <tr>
                <th>Test</th>
                <th>Sonu√ß</th>
                <th>Deƒüer</th>
              </tr>
            </thead>
            <tbody>
      `;
      
      tests.forEach(t => {
        const passClass = t.pass ? 'pass-cell' : 'fail-cell';
        const icon = t.pass ? '‚úÖ' : '‚ùå';
        html += `
              <tr>
                <td>${t.name}</td>
                <td class="${passClass}">${icon}</td>
                <td>${t.value}</td>
              </tr>
        `;
      });
      
      html += `
            </tbody>
          </table>
        </div>
      `;
      
      resultDiv.innerHTML = html;
    }
  </script>
</body>
</html>
